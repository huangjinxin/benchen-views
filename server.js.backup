const express = require('express');
const fs = require('fs').promises;
const path = require('path');
const cors = require('cors');

const app = express();
const PORT = 8828;
const RECORDS_DIR = path.join(__dirname, 'records');

// 中间件
app.use(cors());
app.use(express.json({ limit: '10mb' }));
app.use(express.static(__dirname));

// 确保records目录存在
async function ensureRecordsDir() {
    try {
        await fs.access(RECORDS_DIR);
        console.log('✅ records目录已存在');
    } catch {
        await fs.mkdir(RECORDS_DIR, { recursive: true });
        console.log('✅ 已创建records目录');
    }
}

// 保存记录
app.post('/api/records', async (req, res) => {
    try {
        const data = req.body;
        const date = data.date.replace(/-/g, '');
        const filename = `${date}_${data.class}_${data.teacher}_${data.id}.json`;
        const filepath = path.join(RECORDS_DIR, filename);
        
        await fs.writeFile(filepath, JSON.stringify(data, null, 2), 'utf-8');
        
        console.log(`✅ 保存成功: ${filename}`);
        res.json({ success: true, id: data.id, filename });
    } catch (error) {
        console.error('❌ 保存失败:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// 获取所有记录
app.get('/api/records', async (req, res) => {
    try {
        const files = await fs.readdir(RECORDS_DIR);
        const jsonFiles = files.filter(f => f.endsWith('.json'));
        
        const records = await Promise.all(
            jsonFiles.map(async (file) => {
                const content = await fs.readFile(path.join(RECORDS_DIR, file), 'utf-8');
                return JSON.parse(content);
            })
        );
        
        // 按日期降序排序
        records.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        res.json(records);
    } catch (error) {
        console.error('❌ 读取失败:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// 获取单个记录
app.get('/api/records/:id', async (req, res) => {
    try {
        const files = await fs.readdir(RECORDS_DIR);
        const targetFile = files.find(f => f.includes(req.params.id));
        
        if (!targetFile) {
            return res.status(404).json({ success: false, error: '记录不存在' });
        }
        
        const content = await fs.readFile(path.join(RECORDS_DIR, targetFile), 'utf-8');
        res.json(JSON.parse(content));
    } catch (error) {
        console.error('❌ 读取失败:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// 更新记录
app.put('/api/records/:id', async (req, res) => {
    try {
        const files = await fs.readdir(RECORDS_DIR);
        const oldFile = files.find(f => f.includes(req.params.id));

        if (oldFile) {
            await fs.unlink(path.join(RECORDS_DIR, oldFile));
            console.log(`🗑️ 删除旧文件: ${oldFile}`);
        }

        const data = req.body;
        const date = data.date.replace(/-/g, '');
        const filename = `${date}_${data.class}_${data.teacher}_${data.id}.json`;
        const filepath = path.join(RECORDS_DIR, filename);

        await fs.writeFile(filepath, JSON.stringify(data, null, 2), 'utf-8');

        console.log(`✅ 更新成功: ${filename}`);
        res.json({ success: true, id: data.id, filename });
    } catch (error) {
        console.error('❌ 更新失败:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// 删除记录
app.delete('/api/records/:id', async (req, res) => {
    try {
        const files = await fs.readdir(RECORDS_DIR);
        const targetFile = files.find(f => f.includes(req.params.id));

        if (!targetFile) {
            return res.status(404).json({ success: false, error: '记录不存在' });
        }

        await fs.unlink(path.join(RECORDS_DIR, targetFile));
        console.log(`🗑️ 删除成功: ${targetFile}`);
        res.json({ success: true, filename: targetFile });
    } catch (error) {
        console.error('❌ 删除失败:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// 删除所有记录
app.delete('/api/records', async (_req, res) => {
    try {
        const files = await fs.readdir(RECORDS_DIR);
        const jsonFiles = files.filter(f => f.endsWith('.json'));

        for (const file of jsonFiles) {
            await fs.unlink(path.join(RECORDS_DIR, file));
        }

        console.log(`🗑️ 已删除 ${jsonFiles.length} 条记录`);
        res.json({ success: true, count: jsonFiles.length });
    } catch (error) {
        console.error('❌ 删除所有记录失败:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// 启动服务器
async function startServer() {
    await ensureRecordsDir();
    app.listen(PORT, () => {
        console.log(`
╔════════════════════════════════════════════════════╗
║                                                    ║
║   🌟 北辰幼儿园每日观察系统 启动成功！          ║
║                                                    ║
║   📍 访问地址: http://localhost:${PORT}              ║
║   📁 记录保存: ${RECORDS_DIR}     ║
║   ⏰ 启动时间: ${new Date().toLocaleString('zh-CN')}   ║
║                                                    ║
╚════════════════════════════════════════════════════╝
        `);
    });
}

startServer();